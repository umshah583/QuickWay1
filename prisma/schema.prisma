generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Partner {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String? @unique
  userId    String? @unique
  logoUrl   String?
  account   User?   @relation("PartnerAccount", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  drivers   User[]  @relation("PartnerDrivers")
  bookings  Booking[]
  driverRequests PartnerDriverRequest[]
  serviceRequests PartnerServiceRequest[]
  commissionPercentage Float?
  payouts   PartnerPayout[] @relation("PartnerPayoutPartner")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  name           String?
  email          String?   @unique
  passwordHash   String?
  phoneNumber    String?
  phoneVerified  Boolean   @default(false)
  role           UserRole  @default(USER)
  image          String?
  emailVerified  DateTime?
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  passwordResetToken String?
  passwordResetExpires DateTime?
  accounts       Account[]
  sessions       Session[]
  bookings       Booking[]
  driverBookings Booking[] @relation("DriverBookings")
  partnerId      String?
  partner        Partner?  @relation("PartnerDrivers", fields: [partnerId], references: [id])
  partnerProfile Partner?  @relation("PartnerAccount")
  processedDriverRequests            PartnerDriverRequest[]    @relation("DriverRequestProcessor")
  processedServiceRequests           PartnerServiceRequest[]   @relation("ServiceRequestProcessor")
  processedSubscriptionRequests      SubscriptionRequest[]     @relation("SubscriptionRequestProcessor")
  partnerPayoutsCreated              PartnerPayout[]           @relation("PartnerPayoutCreatedBy")
  pushSubscriptions PushSubscription[]
  loyaltyRedeemedPoints Int @default(0)
  loyaltyCreditCents Int @default(0)
  couponsCreated Coupon[] @relation("CouponCreatedBy")
  couponRedemptions CouponRedemption[]
  feedback       Feedback[]
  packageSubscriptions         PackageSubscription[] @relation("UserSubscriptions")
  driverPackageSubscriptions   PackageSubscription[] @relation("DriverSubscriptions")
  subscriptionDailyDriverAssignments SubscriptionDailyDriver[] @relation("DriverDailySubscriptions")
  subscriptionRequests     SubscriptionRequest[]  @relation("UserSubscriptionRequests")
  refreshToken             String?
  oneTimeCode              String?
  oneTimeCodeExpiry        DateTime?
  pushSubscription         String?
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  locations                UserLocation[]
  businessHoursSet         BusinessHours[]    @relation("BusinessHoursSetBy")
  driverDays               DriverDay[]        @relation("DriverDays")
}

enum PartnerDriverRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PartnerDriverDocumentType {
  LABOUR_CARD
  EMIRATES_ID
}

model PartnerDriverRequest {
  id             String                      @id @default(auto()) @map("_id") @db.ObjectId
  partnerId      String
  partner        Partner                     @relation(fields: [partnerId], references: [id])
  name           String
  email          String
  passwordHash   String
  mobileNumber   String                      @default("")
  visaIssueDate  DateTime?
  visaExpiryDate DateTime?
  documentType   PartnerDriverDocumentType   @default(LABOUR_CARD)
  labourCardFileBytes Bytes?
  labourCardFileName  String?
  labourCardFileType  String?
  emiratesIdFrontBytes Bytes?
  emiratesIdFrontName  String?
  emiratesIdFrontType  String?
  emiratesIdBackBytes  Bytes?
  emiratesIdBackName   String?
  emiratesIdBackType   String?
  status         PartnerDriverRequestStatus  @default(PENDING)
  rejectionReason String?
  processedAt    DateTime?
  processedById  String?
  processedBy    User?                       @relation("DriverRequestProcessor", fields: [processedById], references: [id])
  rejectionCount Int                         @default(0)
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt

  @@index([partnerId, status])
}

enum PartnerServiceRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model PartnerServiceRequest {
  id             String                     @id @default(auto()) @map("_id") @db.ObjectId
  partnerId      String
  partner        Partner                    @relation(fields: [partnerId], references: [id])
  name           String
  description    String?
  imageUrl       String?
  durationMin    Int
  priceCents     Int
  carType        String
  serviceId      String?
  service        Service?                   @relation("ServiceFromPartnerRequest", fields: [serviceId], references: [id])
  status         PartnerServiceRequestStatus @default(PENDING)
  rejectionReason String?
  createdAt      DateTime                   @default(now())
  processedAt    DateTime?
  processedById  String?
  processedBy    User?                      @relation("ServiceRequestProcessor", fields: [processedById], references: [id])

  @@index([partnerId, status])
}

enum UserRole {
  USER
  ADMIN
  DRIVER
  PARTNER
}

model Account {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PartnerPayout {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  partnerId       String
  partner         Partner  @relation("PartnerPayoutPartner", fields: [partnerId], references: [id])
  amountCents     Int
  note            String?
  periodMonth     Int
  periodYear      Int
  createdAt       DateTime @default(now())
  createdByAdminId String?
  createdByAdmin  User?    @relation("PartnerPayoutCreatedBy", fields: [createdByAdminId], references: [id])

  @@index([partnerId, periodYear, periodMonth])
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model ServiceType {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String    @unique
  description String?
  icon        String?
  color       String?
  active      Boolean   @default(true)
  sortOrder   Int       @default(0)
  attributes  Json?     // Array of { name, type: 'text'|'select'|'checkbox', options?: string[] }
  services    Service[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Service {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String?
  durationMin  Int
  priceCents   Int
  discountPercentage Int?
  active       Boolean   @default(true)
  imageUrl     String?
  carTypes     String[]
  attributeValues Json?   // { [attributeName]: value } - stores selected values for service type attributes
  serviceTypeId String?   @db.ObjectId
  serviceType   ServiceType? @relation(fields: [serviceTypeId], references: [id])
  bookings     Booking[]
  partnerServiceRequests PartnerServiceRequest[] @relation("ServiceFromPartnerRequest")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([serviceTypeId])
}

enum CouponDiscountType {
  PERCENTAGE
  AMOUNT
}

model Coupon {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  code        String   @unique
  name        String
  description String?
  discountType CouponDiscountType
  discountValue Int
  maxRedemptions Int?
  maxRedemptionsPerUser Int?
  minBookingAmountCents Int?
  validFrom   DateTime?
  validUntil  DateTime?
  active      Boolean  @default(true)
  appliesToAllServices Boolean @default(true)
  applicableServiceIds String[]
  createdByAdminId String?
  createdByAdmin   User? @relation("CouponCreatedBy", fields: [createdByAdminId], references: [id])
  bookings    Booking[]
  redemptions CouponRedemption[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CouponRedemption {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  couponId   String
  bookingId  String @unique
  userId     String
  amountCents Int
  createdAt  DateTime @default(now())

  coupon  Coupon @relation(fields: [couponId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([couponId])
  @@index([userId])
}

enum BookingStatus {
  ASSIGNED
  PENDING
  PAID
  CANCELLED
}

model Booking {
  id         String         @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  serviceId  String
  startAt    DateTime
  endAt      DateTime
  status     BookingStatus  @default(PENDING)
  driverId   String?
  driver     User?          @relation("DriverBookings", fields: [driverId], references: [id])
  partnerId  String?
  partner    Partner?       @relation(fields: [partnerId], references: [id])
  taskStatus TaskStatus     @default(ASSIGNED)
  cashCollected Boolean     @default(false)
  cashSettled   Boolean     @default(false)
  cashAmountCents Int?      @default(0)
  loyaltyCreditAppliedCents Int @default(0)
  loyaltyCreditConsumed Boolean @default(false)
  loyaltyPointsApplied Int @default(0)
  couponId   String?
  couponCode String?
  couponDiscountCents Int @default(0)
  driverNotes String?
  beforePhotoUrl String?
  afterPhotoUrl  String?
  locationLabel String?
  locationCoordinates String?
  customerLatitude  Float?
  customerLongitude Float?
  driverLatitude    Float?
  driverLongitude   Float?
  driverLocationUpdatedAt DateTime?
  vehicleMake String?
  vehicleModel String?
  vehicleColor String?
  vehicleType String?
  vehiclePlate String?
  vehicleServiceDetails String?
  vehicleCount Int           @default(1)
  partnerCommissionPercentage Float? // Snapshot of commission rate at booking time
  // Pricing snapshots - locked at booking creation time
  servicePriceCents           Int?   // Service price at booking time
  serviceDiscountPercentage   Float? // Service discount at booking time
  taxPercentage               Float? // Tax rate at booking time
  stripeFeePercentage         Float? // Stripe fee at booking time
  extraFeeCents               Int?   // Extra fee at booking time
  payment    Payment?
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  service    Service        @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  coupon     Coupon?        @relation(fields: [couponId], references: [id])
  couponRedemption CouponRedemption?
  feedback   Feedback[]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  taskStartedAt   DateTime?
  taskCompletedAt DateTime?

  @@index([userId, startAt])
  @@index([serviceId, startAt])
  @@index([couponId])
}

model UserLocation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label     String
  address   String
  latitude  Float?
  longitude Float?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum TaskStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  CASH
}

enum PaymentStatus {
  REQUIRES_PAYMENT
  PAID
  REFUNDED
  CANCELED
}

model Payment {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  bookingId   String          @unique
  provider    PaymentProvider
  status      PaymentStatus
  amountCents Int
  sessionId   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  booking     Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

enum NotificationCategory {
  ORDER
  DRIVER
  CUSTOMER
  PAYMENT
  SYSTEM
}

model Notification {
  id         String                @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  message    String
  category   NotificationCategory
  entityType String?
  entityId   String?
  read       Boolean               @default(false)
  createdAt  DateTime              @default(now())
}

model Feedback {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  bookingId  String
  driverId   String?
  serviceId  String
  message    String
  rating     Int?
  read       Boolean  @default(false)
  readAt     DateTime?
  createdAt  DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])
}

model AdminSetting {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     String?
  updatedAt DateTime @updatedAt
}

enum PackageDuration {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PackageStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model MonthlyPackage {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  duration          PackageDuration @default(MONTHLY)
  washesPerMonth    Int
  priceCents        Int
  discountPercent   Int?            @default(0)
  features          String[]        // Array of feature strings
  popular           Boolean         @default(false)
  status            PackageStatus   @default(ACTIVE)
  serviceIds        String[]        // Services included in package
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  subscriptions     PackageSubscription[]
  subscriptionRequests SubscriptionRequest[] @relation("PackageSubscriptionRequests")

  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

model PackageSubscription {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  userId             String
  user               User               @relation("UserSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  packageId          String
  package            MonthlyPackage     @relation(fields: [packageId], references: [id])
  status             SubscriptionStatus @default(ACTIVE)
  startDate          DateTime
  endDate            DateTime
  washesRemaining    Int
  washesUsed         Int                @default(0)
  autoRenew          Boolean            @default(true)
  paymentId          String?
  pricePaidCents     Int
  lastRenewalDate    DateTime?
  nextRenewalDate    DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  preferredWashDates String[]           @default([])
  driverId           String?
  driver             User?              @relation("DriverSubscriptions", fields: [driverId], references: [id])
  dailyDrivers       SubscriptionDailyDriver[] @relation("SubscriptionDailyDrivers")
  vehicleMake        String?
  vehicleModel       String?
  vehicleColor       String?
  vehicleType        String?
  vehiclePlate       String?
  locationLabel      String?
  locationCoordinates String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([userId, status])
  @@index([packageId])
}

model SubscriptionRequest {
  id                  String                    @id @default(auto()) @map("_id") @db.ObjectId
  userId              String
  user                User                      @relation("UserSubscriptionRequests", fields: [userId], references: [id], onDelete: Cascade)
  packageId           String
  package             MonthlyPackage            @relation("PackageSubscriptionRequests", fields: [packageId], references: [id])
  status              SubscriptionRequestStatus @default(PENDING)
  scheduleDates       String[]                  @default([])
  vehicleMake         String?
  vehicleModel        String?
  vehicleColor        String?
  vehicleType         String?
  vehiclePlate        String?
  locationLabel       String?
  locationCoordinates String?
  paymentIntentId     String?
  subscriptionId      String?
  rejectionReason     String?
  approvedAt          DateTime?
  rejectedAt          DateTime?
  completedAt         DateTime?
  processedAt         DateTime?
  processedById       String?
  processedBy         User?                      @relation("SubscriptionRequestProcessor", fields: [processedById], references: [id])
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt

  @@index([userId, status])
  @@index([status])
}

model SubscriptionDailyDriver {
  id              String              @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId  String
  subscription    PackageSubscription @relation("SubscriptionDailyDrivers", fields: [subscriptionId], references: [id], onDelete: Cascade)
  date            String
  driverId        String
  driver          User                @relation("DriverDailySubscriptions", fields: [driverId], references: [id])
  taskStatus      TaskStatus          @default(ASSIGNED)
  taskStartedAt   DateTime?
  taskCompletedAt DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([subscriptionId, date])
}

enum SubscriptionRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum BusinessDayStatus {
  OPEN
  CLOSED
}

model BusinessHours {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  startTime         String    // e.g., "09:00" - start time for business day
  endTime           String    // e.g., "17:00" - end time for business day
  durationHours     Int       // Duration in hours (2, 24, etc.)
  isActive          Boolean   @default(true) // Whether these hours are currently active
  setById           String
  setBy             User      @relation("BusinessHoursSetBy", fields: [setById], references: [id])
  setAt             DateTime  @default(now())
  notes             String?

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([isActive])
  @@index([setById])
}

model DriverDay {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  driverId          String
  driver            User              @relation("DriverDays", fields: [driverId], references: [id])
  date              DateTime          // The business date for this shift
  status            BusinessDayStatus @default(OPEN)

  // Shift timing
  startedAt         DateTime          @default(now())
  endedAt           DateTime?

  // Tasks completed during this shift
  tasksCompleted    Int               @default(0)
  tasksInProgress   Int               @default(0)

  // Cash collection for this shift
  cashCollectedCents Int              @default(0)
  cashSettledCents   Int              @default(0) // Amount settled/paid out

  // Notes
  startNotes        String?
  endNotes          String?

  // Metadata
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([driverId, status])
  @@index([date, status])
  @@unique([driverId, date]) // One shift per driver per date
}
