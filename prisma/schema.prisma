generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Partner {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String? @unique
  userId    String? @unique
  account   User?   @relation("PartnerAccount", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  drivers   User[]  @relation("PartnerDrivers")
  bookings  Booking[]
  driverRequests PartnerDriverRequest[]
  commissionPercentage Float?
  payouts   PartnerPayout[] @relation("PartnerPayoutPartner")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  name           String?
  email          String?   @unique
  passwordHash   String?
  phoneNumber    String?
  phoneVerified  Boolean   @default(false)
  role           UserRole  @default(USER)
  image          String?
  emailVerified  DateTime?
  accounts       Account[]
  sessions       Session[]
  bookings       Booking[]
  driverBookings Booking[] @relation("DriverBookings")
  partnerId      String?
  partner        Partner?  @relation("PartnerDrivers", fields: [partnerId], references: [id])
  partnerProfile Partner?  @relation("PartnerAccount")
  processedDriverRequests PartnerDriverRequest[] @relation("DriverRequestProcessor")
  partnerPayoutsCreated PartnerPayout[] @relation("PartnerPayoutCreatedBy")
  pushSubscriptions PushSubscription[]
  loyaltyRedeemedPoints Int @default(0)
  loyaltyCreditCents Int @default(0)
  couponsCreated Coupon[] @relation("CouponCreatedBy")
  couponRedemptions CouponRedemption[]
  packageSubscriptions PackageSubscription[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

enum PartnerDriverRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PartnerDriverDocumentType {
  LABOUR_CARD
  EMIRATES_ID
}

model PartnerDriverRequest {
  id             String                      @id @default(auto()) @map("_id") @db.ObjectId
  partnerId      String
  partner        Partner                     @relation(fields: [partnerId], references: [id])
  name           String
  email          String
  passwordHash   String
  mobileNumber   String                      @default("")
  visaIssueDate  DateTime?
  visaExpiryDate DateTime?
  documentType   PartnerDriverDocumentType   @default(LABOUR_CARD)
  labourCardFileBytes Bytes?
  labourCardFileName  String?
  labourCardFileType  String?
  emiratesIdFrontBytes Bytes?
  emiratesIdFrontName  String?
  emiratesIdFrontType  String?
  emiratesIdBackBytes  Bytes?
  emiratesIdBackName   String?
  emiratesIdBackType   String?
  status         PartnerDriverRequestStatus  @default(PENDING)
  rejectionReason String?
  processedAt    DateTime?
  processedById  String?
  processedBy    User?                       @relation("DriverRequestProcessor", fields: [processedById], references: [id])
  rejectionCount Int                         @default(0)
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt

  @@index([partnerId, status])
}

enum UserRole {
  USER
  ADMIN
  DRIVER
  PARTNER
}

model Account {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PartnerPayout {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  partnerId       String
  partner         Partner  @relation("PartnerPayoutPartner", fields: [partnerId], references: [id])
  amountCents     Int
  note            String?
  periodMonth     Int
  periodYear      Int
  createdAt       DateTime @default(now())
  createdByAdminId String?
  createdByAdmin  User?    @relation("PartnerPayoutCreatedBy", fields: [createdByAdminId], references: [id])

  @@index([partnerId, periodYear, periodMonth])
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Service {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String?
  durationMin  Int
  priceCents   Int
  discountPercentage Int?
  active       Boolean   @default(true)
  bookings     Booking[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

enum CouponDiscountType {
  PERCENTAGE
  AMOUNT
}

model Coupon {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  code        String   @unique
  name        String
  description String?
  discountType CouponDiscountType
  discountValue Int
  maxRedemptions Int?
  maxRedemptionsPerUser Int?
  minBookingAmountCents Int?
  validFrom   DateTime?
  validUntil  DateTime?
  active      Boolean  @default(true)
  appliesToAllServices Boolean @default(true)
  applicableServiceIds String[]
  createdByAdminId String?
  createdByAdmin   User? @relation("CouponCreatedBy", fields: [createdByAdminId], references: [id])
  bookings    Booking[]
  redemptions CouponRedemption[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CouponRedemption {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  couponId   String
  bookingId  String @unique
  userId     String
  amountCents Int
  createdAt  DateTime @default(now())

  coupon  Coupon @relation(fields: [couponId], references: [id])
  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([couponId])
  @@index([userId])
}

enum BookingStatus {
  ASSIGNED
  PENDING
  PAID
  CANCELLED
}

model Booking {
  id         String         @id @default(auto()) @map("_id") @db.ObjectId
  userId     String
  serviceId  String
  startAt    DateTime
  endAt      DateTime
  status     BookingStatus  @default(PENDING)
  driverId   String?
  driver     User?          @relation("DriverBookings", fields: [driverId], references: [id])
  partnerId  String?
  partner    Partner?       @relation(fields: [partnerId], references: [id])
  taskStatus TaskStatus     @default(ASSIGNED)
  cashCollected Boolean     @default(false)
  cashSettled   Boolean     @default(false)
  cashAmountCents Int?      @default(0)
  loyaltyCreditAppliedCents Int @default(0)
  loyaltyCreditConsumed Boolean @default(false)
  loyaltyPointsApplied Int @default(0)
  couponId   String?
  couponCode String?
  couponDiscountCents Int @default(0)
  driverNotes String?
  locationLabel String?
  locationCoordinates String?
  vehicleMake String?
  vehicleModel String?
  vehicleColor String?
  vehicleType String?
  vehiclePlate String?
  payment    Payment?
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  service    Service        @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  coupon     Coupon?        @relation(fields: [couponId], references: [id])
  couponRedemption CouponRedemption?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  taskStartedAt   DateTime?
  taskCompletedAt DateTime?

  @@index([userId, startAt])
  @@index([serviceId, startAt])
  @@index([couponId])
}

enum TaskStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  CASH
}

enum PaymentStatus {
  REQUIRES_PAYMENT
  PAID
  REFUNDED
  CANCELED
}

model Payment {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  bookingId   String          @unique
  provider    PaymentProvider
  status      PaymentStatus
  amountCents Int
  sessionId   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  booking     Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

enum NotificationCategory {
  ORDER
  DRIVER
  CUSTOMER
  PAYMENT
  SYSTEM
}

model Notification {
  id         String                @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  message    String
  category   NotificationCategory
  entityType String?
  entityId   String?
  read       Boolean               @default(false)
  createdAt  DateTime              @default(now())
}

model AdminSetting {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     String?
  updatedAt DateTime @updatedAt
}

enum PackageDuration {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PackageStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model MonthlyPackage {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  duration          PackageDuration @default(MONTHLY)
  washesPerMonth    Int
  priceCents        Int
  discountPercent   Int?            @default(0)
  features          String[]        // Array of feature strings
  popular           Boolean         @default(false)
  status            PackageStatus   @default(ACTIVE)
  serviceIds        String[]        // Services included in package
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  subscriptions     PackageSubscription[]

  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

model PackageSubscription {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  userId             String
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  packageId          String
  package            MonthlyPackage     @relation(fields: [packageId], references: [id])
  status             SubscriptionStatus @default(ACTIVE)
  startDate          DateTime
  endDate            DateTime
  washesRemaining    Int
  washesUsed         Int                @default(0)
  autoRenew          Boolean            @default(true)
  paymentId          String?
  pricePaidCents     Int
  lastRenewalDate    DateTime?
  nextRenewalDate    DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  preferredWashDates String[]           @default([])
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([userId, status])
  @@index([packageId])
}
