generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserModulePermission {
  id        String  @id @default(cuid())
  userId    String
  moduleId  String
  enabled   Boolean @default(true)
  canView   Boolean @default(true)
  canCreate Boolean @default(false)
  canEdit   Boolean @default(false)
  canDelete Boolean @default(false)
  module    Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
}

model Partner {
  id                   String                  @id @default(cuid())
  name                 String
  email                String?                 @unique
  userId               String?                 @unique
  logoUrl              String?
  commissionPercentage Float?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  bookings             Booking[]
  account              User?                   @relation("PartnerAccount", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  driverRequests       PartnerDriverRequest[]
  payouts              PartnerPayout[]         @relation("PartnerPayoutPartner")
  serviceRequests      PartnerServiceRequest[]
  drivers              User[]                  @relation("PartnerDrivers")
}

model User {
  id                                 String                    @id @default(cuid())
  name                               String?
  email                              String?                   @unique
  passwordHash                       String?
  phoneNumber                        String?
  phoneVerified                      Boolean                   @default(false)
  role                               UserRole                  @default(USER)
  image                              String?
  emailVerified                      DateTime?
  emailVerificationToken             String?
  emailVerificationExpires           DateTime?
  passwordResetToken                 String?
  passwordResetExpires               DateTime?
  partnerId                          String?
  loyaltyRedeemedPoints              Int                       @default(0)
  loyaltyCreditCents                 Int                       @default(0)
  refreshToken                       String?
  oneTimeCode                        String?
  oneTimeCodeExpiry                  DateTime?
  pushSubscription                   String?
  fcmToken                           String?
  createdAt                          DateTime                  @default(now())
  updatedAt                          DateTime                  @updatedAt
  roleId                             String?
  accounts                           Account[]
  driverBookings                     Booking[]                 @relation("DriverBookings")
  bookings                           Booking[]
  businessHoursSet                   BusinessHours[]           @relation("BusinessHoursSetBy")
  couponsCreated                     Coupon[]                  @relation("CouponCreatedBy")
  couponRedemptions                  CouponRedemption[]
  driverDays                         DriverDay[]               @relation("DriverDays")
  feedback                           Feedback[]
  notifications                      Notification[]
  driverPackageSubscriptions         PackageSubscription[]     @relation("DriverSubscriptions")
  packageSubscriptions               PackageSubscription[]     @relation("UserSubscriptions")
  partnerProfile                     Partner?                  @relation("PartnerAccount")
  processedDriverRequests            PartnerDriverRequest[]    @relation("DriverRequestProcessor")
  partnerPayoutsCreated              PartnerPayout[]           @relation("PartnerPayoutCreatedBy")
  processedServiceRequests           PartnerServiceRequest[]   @relation("ServiceRequestProcessor")
  pushSubscriptions                  PushSubscription[]
  sessions                           Session[]
  subscriptionDailyDriverAssignments SubscriptionDailyDriver[] @relation("DriverDailySubscriptions")
  processedSubscriptionRequests      SubscriptionRequest[]     @relation("SubscriptionRequestProcessor")
  subscriptionRequests               SubscriptionRequest[]     @relation("UserSubscriptionRequests")
  partner                            Partner?                  @relation("PartnerDrivers", fields: [partnerId], references: [id])
  roleRelation                       Role?                     @relation("UserRoleRelation", fields: [roleId], references: [id])
  locations                          UserLocation[]
  moduleOverrides                    UserModulePermission[]
  permissionOverrides                UserPermission[]
  fcmTokens                          FCMToken[]                @relation("UserFCMTokens")
}

model FCMToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  appType   AppType
  platform  Platform
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("UserFCMTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, appType, platform])
  @@index([userId])
  @@map("fcm_tokens")
}

model PartnerDriverRequest {
  id                   String                     @id @default(cuid())
  partnerId            String
  name                 String
  email                String
  passwordHash         String
  mobileNumber         String                     @default("")
  visaIssueDate        DateTime?
  visaExpiryDate       DateTime?
  documentType         PartnerDriverDocumentType  @default(LABOUR_CARD)
  labourCardFileBytes  Bytes?
  labourCardFileName   String?
  labourCardFileType   String?
  emiratesIdFrontBytes Bytes?
  emiratesIdFrontName  String?
  emiratesIdFrontType  String?
  emiratesIdBackBytes  Bytes?
  emiratesIdBackName   String?
  emiratesIdBackType   String?
  status               PartnerDriverRequestStatus @default(PENDING)
  rejectionReason      String?
  processedAt          DateTime?
  processedById        String?
  rejectionCount       Int                        @default(0)
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  partner              Partner                    @relation(fields: [partnerId], references: [id])
  processedBy          User?                      @relation("DriverRequestProcessor", fields: [processedById], references: [id])

  @@index([partnerId, status])
}

model PartnerServiceRequest {
  id              String                      @id @default(cuid())
  partnerId       String
  name            String
  description     String?
  imageUrl        String?
  durationMin     Int
  priceCents      Int
  carType         String
  serviceTypeId   String?
  attributeValues Json?
  serviceId       String?
  status          PartnerServiceRequestStatus @default(PENDING)
  rejectionReason String?
  createdAt       DateTime                    @default(now())
  processedAt     DateTime?
  processedById   String?
  partner         Partner                     @relation(fields: [partnerId], references: [id])
  processedBy     User?                       @relation("ServiceRequestProcessor", fields: [processedById], references: [id])
  service         Service?                    @relation("ServiceFromPartnerRequest", fields: [serviceId], references: [id])
  serviceType     ServiceType?                @relation(fields: [serviceTypeId], references: [id])

  @@index([partnerId, status])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PartnerPayout {
  id               String   @id @default(cuid())
  partnerId        String
  amountCents      Int
  note             String?
  periodMonth      Int
  periodYear       Int
  createdAt        DateTime @default(now())
  createdByAdminId String?
  createdByAdmin   User?    @relation("PartnerPayoutCreatedBy", fields: [createdByAdminId], references: [id])
  partner          Partner  @relation("PartnerPayoutPartner", fields: [partnerId], references: [id])

  @@index([partnerId, periodYear, periodMonth])
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model ServiceType {
  id                     String                  @id @default(cuid())
  name                   String                  @unique
  description            String?
  icon                   String?
  color                  String?
  active                 Boolean                 @default(true)
  sortOrder              Int                     @default(0)
  attributes             Json?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  packages               MonthlyPackage[]        @relation("ServiceTypePackages")
  partnerServiceRequests PartnerServiceRequest[]
  services               Service[]
}

model Service {
  id                     String                  @id @default(cuid())
  name                   String
  description            String?
  durationMin            Int
  priceCents             Int
  discountPercentage     Int?
  active                 Boolean                 @default(true)
  imageUrl               String?
  carTypes               String[]
  attributeValues        Json?
  serviceTypeId          String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  bookings               Booking[]
  partnerServiceRequests PartnerServiceRequest[] @relation("ServiceFromPartnerRequest")
  serviceType            ServiceType?            @relation(fields: [serviceTypeId], references: [id])

  @@index([serviceTypeId])
}

model Coupon {
  id                    String             @id @default(cuid())
  code                  String             @unique
  name                  String
  description           String?
  discountType          CouponDiscountType
  discountValue         Int
  maxRedemptions        Int?
  maxRedemptionsPerUser Int?
  minBookingAmountCents Int?
  validFrom             DateTime?
  validUntil            DateTime?
  active                Boolean            @default(true)
  appliesToAllServices  Boolean            @default(true)
  applicableServiceIds  String[]
  createdByAdminId      String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  bookings              Booking[]
  freeWashBookings      Booking[]          @relation("FreeWashRewardCoupon")
  createdByAdmin        User?              @relation("CouponCreatedBy", fields: [createdByAdminId], references: [id])
  redemptions           CouponRedemption[]
}

model CouponRedemption {
  id          String   @id @default(cuid())
  couponId    String
  bookingId   String   @unique
  userId      String
  amountCents Int
  createdAt   DateTime @default(now())
  booking     Booking  @relation(fields: [bookingId], references: [id])
  coupon      Coupon   @relation(fields: [couponId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([couponId])
  @@index([userId])
}

model Booking {
  id                          String            @id @default(cuid())
  userId                      String
  serviceId                   String
  startAt                     DateTime
  endAt                       DateTime
  status                      BookingStatus     @default(PENDING)
  driverId                    String?
  partnerId                   String?
  taskStatus                  TaskStatus        @default(ASSIGNED)
  cashCollected               Boolean           @default(false)
  cashSettled                 Boolean           @default(false)
  cashAmountCents             Int?              @default(0)
  loyaltyCreditAppliedCents   Int               @default(0)
  loyaltyCreditConsumed       Boolean           @default(false)
  loyaltyPointsApplied        Int               @default(0)
  couponId                    String?
  couponCode                  String?
  couponDiscountCents         Int               @default(0)
  driverNotes                 String?
  beforePhotoUrl              String?
  afterPhotoUrl               String?
  freeWashRewardCouponId      String?
  freeWashRewardCouponCode    String?
  freeWashRewardIssuedAt      DateTime?
  locationLabel               String?
  locationCoordinates         String?
  customerLatitude            Float?
  customerLongitude           Float?
  driverLatitude              Float?
  driverLongitude             Float?
  driverLocationUpdatedAt     DateTime?
  vehicleMake                 String?
  vehicleModel                String?
  vehicleColor                String?
  vehicleType                 String?
  vehiclePlate                String?
  vehicleServiceDetails       String?
  vehicleCount                Int               @default(1)
  partnerCommissionPercentage Float?
  servicePriceCents           Int?
  serviceDiscountPercentage   Float?
  taxPercentage               Float?
  stripeFeePercentage         Float?
  extraFeeCents               Int?
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt
  taskStartedAt               DateTime?
  taskCompletedAt             DateTime?
  coupon                      Coupon?           @relation(fields: [couponId], references: [id])
  driver                      User?             @relation("DriverBookings", fields: [driverId], references: [id])
  freeWashRewardCoupon        Coupon?           @relation("FreeWashRewardCoupon", fields: [freeWashRewardCouponId], references: [id])
  partner                     Partner?          @relation(fields: [partnerId], references: [id])
  service                     Service           @relation(fields: [serviceId], references: [id])
  user                        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponRedemption            CouponRedemption?
  feedback                    Feedback[]
  payment                     Payment?

  @@index([userId, startAt])
  @@index([serviceId, startAt])
  @@index([couponId])
}

model UserLocation {
  id        String   @id @default(cuid())
  userId    String
  label     String
  address   String
  latitude  Float?
  longitude Float?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Payment {
  id          String          @id @default(cuid())
  bookingId   String          @unique
  provider    PaymentProvider
  status      PaymentStatus
  amountCents Int
  sessionId   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  booking     Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String?
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id         String               @id @default(cuid())
  userId     String
  title      String
  message    String
  category   NotificationCategory
  entityType String?
  entityId   String?
  read       Boolean              @default(false)
  readAt     DateTime?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

model Permission {
  id            String           @id @default(cuid())
  key           String           @unique
  name          String
  description   String?
  module        String
  action        String
  roles         RolePermission[]
  userOverrides UserPermission[]

  @@unique([module, action])
}

model Role {
  id                String                 @id @default(cuid())
  key               String                 @unique
  name              String
  description       String?
  active            Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  isSystemRole      Boolean                @default(false)
  modulePermissions RoleModulePermission[]
  permissions       RolePermission[]
  users             User[]                 @relation("UserRoleRelation")

  @@index([active])
}

model Module {
  id              String                 @id @default(cuid())
  key             String                 @unique
  name            String
  description     String?
  icon            String?
  path            String
  sortOrder       Int                    @default(0)
  active          Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  rolePermissions RoleModulePermission[]
  userOverrides   UserModulePermission[]

  @@index([active])
  @@index([sortOrder])
}

model RoleModulePermission {
  id        String  @id @default(cuid())
  roleId    String
  moduleId  String
  enabled   Boolean @default(true)
  canView   Boolean @default(true)
  canCreate Boolean @default(false)
  canEdit   Boolean @default(false)
  canDelete Boolean @default(false)
  module    Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  role      Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, moduleId])
  @@index([roleId])
  @@index([moduleId])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  granted      Boolean
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
}

model Feedback {
  id        String    @id @default(cuid())
  userId    String
  bookingId String
  driverId  String?
  serviceId String
  message   String
  rating    Int?
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  booking   Booking   @relation(fields: [bookingId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
}

model AdminSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  updatedAt DateTime @updatedAt
}

model MonthlyPackage {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  duration             PackageDuration       @default(MONTHLY)
  washesPerMonth       Int
  priceCents           Int
  discountPercent      Int?                  @default(0)
  features             String[]
  popular              Boolean               @default(false)
  status               PackageStatus         @default(ACTIVE)
  serviceIds           String[]
  serviceTypeId        String?
  selectedAttributes   String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  serviceType          ServiceType?          @relation("ServiceTypePackages", fields: [serviceTypeId], references: [id])
  subscriptions        PackageSubscription[]
  subscriptionRequests SubscriptionRequest[] @relation("PackageSubscriptionRequests")

  @@index([status])
  @@index([serviceTypeId])
}

model PackageSubscription {
  id                  String                    @id @default(cuid())
  userId              String
  packageId           String
  status              SubscriptionStatus        @default(ACTIVE)
  startDate           DateTime
  endDate             DateTime
  washesRemaining     Int
  washesUsed          Int                       @default(0)
  autoRenew           Boolean                   @default(true)
  paymentId           String?
  pricePaidCents      Int
  lastRenewalDate     DateTime?
  nextRenewalDate     DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?
  preferredWashDates  String[]                  @default([])
  driverId            String?
  vehicleMake         String?
  vehicleModel        String?
  vehicleColor        String?
  vehicleType         String?
  vehiclePlate        String?
  locationLabel       String?
  locationCoordinates String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  driver              User?                     @relation("DriverSubscriptions", fields: [driverId], references: [id])
  package             MonthlyPackage            @relation(fields: [packageId], references: [id])
  user                User                      @relation("UserSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  dailyDrivers        SubscriptionDailyDriver[] @relation("SubscriptionDailyDrivers")

  @@index([userId, status])
  @@index([packageId])
}

model SubscriptionRequest {
  id                  String                    @id @default(cuid())
  userId              String
  packageId           String
  serviceTypeId       String?
  serviceTypeName     String?
  selectedAttributes  String?
  status              SubscriptionRequestStatus @default(PENDING)
  scheduleDates       String[]                  @default([])
  vehicleMake         String?
  vehicleModel        String?
  vehicleColor        String?
  vehicleType         String?
  vehiclePlate        String?
  locationLabel       String?
  locationCoordinates String?
  paymentIntentId     String?
  subscriptionId      String?
  rejectionReason     String?
  approvedAt          DateTime?
  rejectedAt          DateTime?
  completedAt         DateTime?
  processedAt         DateTime?
  processedById       String?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  package             MonthlyPackage            @relation("PackageSubscriptionRequests", fields: [packageId], references: [id])
  processedBy         User?                     @relation("SubscriptionRequestProcessor", fields: [processedById], references: [id])
  user                User                      @relation("UserSubscriptionRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status])
}

model SubscriptionDailyDriver {
  id              String              @id @default(cuid())
  subscriptionId  String
  date            String
  driverId        String
  taskStatus      TaskStatus          @default(ASSIGNED)
  taskStartedAt   DateTime?
  taskCompletedAt DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  driver          User                @relation("DriverDailySubscriptions", fields: [driverId], references: [id])
  subscription    PackageSubscription @relation("SubscriptionDailyDrivers", fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, date])
}

model BusinessHours {
  id            String   @id @default(cuid())
  startTime     String
  endTime       String
  durationHours Int
  isActive      Boolean  @default(true)
  setById       String
  setAt         DateTime @default(now())
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  setBy         User     @relation("BusinessHoursSetBy", fields: [setById], references: [id])

  @@index([isActive])
  @@index([setById])
}

model DriverDay {
  id                 String            @id @default(cuid())
  driverId           String
  date               DateTime
  status             BusinessDayStatus @default(OPEN)
  startedAt          DateTime          @default(now())
  endedAt            DateTime?
  tasksCompleted     Int               @default(0)
  tasksInProgress    Int               @default(0)
  cashCollectedCents Int               @default(0)
  cashSettledCents   Int               @default(0)
  startNotes         String?
  endNotes           String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  driver             User              @relation("DriverDays", fields: [driverId], references: [id])

  @@unique([driverId, date])
  @@index([driverId, status])
  @@index([date, status])
}

model NotificationV2 {
  id          String               @id @default(cuid())
  userId      String
  appType     AppType
  title       String
  body        String
  category    NotificationCategory
  entityType  String?
  entityId    String?
  actionUrl   String?
  payload     Json?
  status      NotificationStatusV2 @default(PENDING)
  deliveredAt DateTime?
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([userId, appType, status])
  @@index([userId, appType, createdAt])
  @@index([createdAt])
  @@map("notifications_v2")
}

model PermissionV2 {
  id              String             @id @default(cuid())
  key             String             @unique
  name            String
  description     String?
  appType         AppType
  createdAt       DateTime           @default(now())
  userPermissions UserPermissionV2[]

  @@index([appType])
  @@map("permissions_v2")
}

model UserPermissionV2 {
  id           String       @id @default(cuid())
  userId       String
  permissionId String
  createdAt    DateTime     @default(now())
  permission   PermissionV2 @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@map("user_permissions_v2")
}

enum PartnerDriverRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PartnerDriverDocumentType {
  LABOUR_CARD
  EMIRATES_ID
}

enum PartnerServiceRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  USER
  ADMIN
  DRIVER
  PARTNER
}

enum CouponDiscountType {
  PERCENTAGE
  AMOUNT
}

enum BookingStatus {
  ASSIGNED
  PENDING
  PAID
  CANCELLED
}

enum TaskStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  CASH
}

enum PaymentStatus {
  REQUIRES_PAYMENT
  PAID
  REFUNDED
  CANCELED
}

enum NotificationCategory {
  ORDER
  DRIVER
  CUSTOMER
  PAYMENT
  SYSTEM
  PROMOTIONAL
}

enum PackageDuration {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PackageStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum SubscriptionRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum BusinessDayStatus {
  OPEN
  CLOSED
}

enum AppType {
  CUSTOMER
  DRIVER
}

enum Platform {
  ios
  android
}

enum NotificationStatusV2 {
  PENDING
  DELIVERED
  READ
  FAILED
}
